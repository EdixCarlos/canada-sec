import { Component, EventEmitter, Input, OnInit, Output } from '@angular/core';
import { FormBuilder, FormGroup } from '@angular/forms';
import { BehaviorSubject, forkJoin } from 'rxjs';
import { take } from 'rxjs/operators';
import { DbTicket, ObjFile } from 'src/app/core/model/db-ticket.model';
import { MaintainersService } from 'src/app/core/_services/maintainers.service';
import { AuthenticationService } from 'src/app/modules/auth';
import { MinLength, MaxLength, TicketStatusJSON } from 'src/app/shared/constants';

@Component({
  selector: 'app-mon-cyb-ale-view',
  templateUrl: './mon-cyb-ale-view.component.html',
  styleUrls: ['./mon-cyb-ale-view.component.scss']
})
export class MonCybAleViewComponent implements OnInit {
  @Output() viewData = new EventEmitter();
  @Output() viewFile = new EventEmitter<any>();

  public ticket: DbTicket = new DbTicket();

  public ticketStatus = TicketStatusJSON;

  formGroup: FormGroup;
  public minLength = MinLength;
  public maxLength = MaxLength;

  userPolicies = [];

  public resolutionList = [];
  public resolutionReasonList = [];

  public objFile: ObjFile;

  constructor(
    private fb: FormBuilder,
    private authService: AuthenticationService,
    private mntService: MaintainersService,
  ) { }

  ngOnInit(): void {
    this.getLists();
    this.createForm();
    this.formGroup.disable();
    this.formControls.progress.enable();
    this.formControls.resolution.enable();
    this.formControls.resolutionReason.enable();
  }

  checkObservable(ticket) {
    this.authService.user.pipe(take(1)).subscribe(
      (user) => {
        this.userPolicies = user.policies;
      }
    );
    this.ticket = ticket;
    this.setView(ticket);
  }

  get formControls() {
    return this.formGroup.controls;
  }

  createForm() {
    this.formGroup = this.fb.group({
      nroTicket: [''],
      requestDate: [null],
      attentionDate: [null],
      idStatus: [],
      assigned: [null],
      emailAssigned: [null],
      progress: [0],
      resolution: [null],
      resolutionReason: [null],
    });
  }

  setView(ticket) {
    let data = JSON.parse(ticket.data);
    let datos = JSON.parse(data.datos);
    this.formControls.nroTicket.setValue(ticket.id);
    this.formControls.requestDate.setValue(this.dateFormatFun(ticket.requestDate));
    this.formControls.attentionDate.setValue(this.dateFormatFun(ticket.attentionDate));
    this.formControls.idStatus.setValue(this.ticketStatus[ticket.idStatus].description);
    this.formControls.assigned.setValue(data.nombre_ejecutor);
    this.formControls.emailAssigned.setValue(data.mail_ejecutor);
    this.formControls.progress.setValue(ticket.progress);
    this.formControls.resolution.setValue(datos.resolution);
    this.formControls.resolutionReason.setValue(datos.resolutionReason);
    if (datos.file) {
      this.objFile = datos.file;
    }
  }

  dateFormatFun(date) {
    if(date == null)
      return null;

    let localDate = new Date(date).toLocaleDateString();
    let localTime = new Date(date).toLocaleTimeString();

    return `${localDate} ${localTime}`;
  }

  sendViewData() {
    this.viewData.emit(this.formGroup.getRawValue());
  }

  getLists() {
    forkJoin([
      this.mntService.getResolutionList(),
      this.mntService.getResolutionReasonList(),
    ]).subscribe(([res1, res2]) => {
      this.resolutionList = res1;
      this.resolutionReasonList = res2;
    });
  }

  pushObjFile(objFile: ObjFile) {
    this.objFile = objFile;
    this.viewFile.emit(this.objFile);
  }

  getFileByControl(control) {
    return this.objFile;
  }
}
