import { Component, Inject, OnInit } from '@angular/core';
import { FormArray, FormBuilder, FormGroup, Validators } from '@angular/forms';
import { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';
import { Country } from 'src/app/core/model/country';
import { Region } from 'src/app/core/model/region';
import { Location } from 'src/app/core/model/location';
import { MaintainersService } from 'src/app/core/_services/maintainers.service';
import { ValidatorsService } from 'src/app/core/_services/validators.service';

@Component({
  selector: 'app-region-modal',
  templateUrl: './region-modal.component.html',
  styleUrls: ['./region-modal.component.scss']
})
export class RegionModalComponent implements OnInit {
  formGroup: FormGroup;
  regionId = 0;
  countryList: Country[] = [];
  selectedCountries: any[] = [];
  regionList: Region[] = [];
  countries: FormArray;
  entityList: any[] = [];
  selectedEntities: any[] = [];
  cisoLocal: string = '';

  constructor(
    private mntService: MaintainersService,
    public dialogRef: MatDialogRef<RegionModalComponent>,
    @Inject(MAT_DIALOG_DATA) public data: Location,
    private fb: FormBuilder,
    public validatorService: ValidatorsService
  ) {

  }

  get formControls() {
    return this.formGroup.controls;
  }

  loadForm() {
    this.formGroup = this.fb.group({
      region: ['', Validators.required],
      countries: ['', Validators.required],
      entities: ['', Validators.required],
    });
    //this.countries = this.formGroup.get('countries') as FormArray;
  }

  setData() {
    if (this.data.region) {
      this.formGroup.controls['countries'].setValue(this.data.countries)
      this.formGroup.controls['region'].setValue(this.data.region)
      this.formGroup.controls['entities'].setValue(this.data.entities)
    }
  }

  ngOnInit(): void {
    this.loadForm();
    //this.setData();
    this.mntService.getRegions().subscribe(regions => {
      this.regionList = regions;
    })
  }

  onChangeRegion(event) {
    this.regionId = event.value;
    this.getCountriesByRegionId(event.value);
  }

  onChangeCountry(event) {
    this.entityList = [];
    this.cisoLocal = '';
    this.selectedCountries = event.value;
    event.value.forEach(country => {
      this.getEntityByCountryId(country);
      this.getCisoByCountryId(country);
    });
  }

  onChangeEntity(event) {
    this.selectedEntities = event.value;
  }

  getCountriesByRegionId(id) {
    this.countryList = [];
    this.mntService.getCountriesByRegionId(id).subscribe(countries => {
      this.countryList = countries;
    })
  }

  getEntityByCountryId(country) {
    this.mntService.getEntityByCountryId(country.id).subscribe(entities => {
      entities.forEach(entity => {
        entity.regionId = this.regionId;
        entity.value = country.value + ' - ' + entity.value;
        this.entityList.push(entity);
      });
    })
  }

  getCisoByCountryId(country) {
    this.mntService.getCisoByCountryId(country.id).subscribe(cisos => {
      cisos.forEach(ciso => {
        ciso.value = country.value + ' - ' + ciso.value;
        if (this.cisoLocal != '') {
          this.cisoLocal = this.cisoLocal + ', ' + ciso.value;
        } else {
          this.cisoLocal = ciso.value;
        }
      });
    })
  }

  closeModal() {
    this.dialogRef.close();
  }

  save() {
    const location: Location = {
      region: this.getSelectedRegion(),
      countries: this.selectedCountries,
      entities: this.selectedEntities,
      localCiso: this.cisoLocal
    }
    this.dialogRef.close(location);
  }

  getSelectedRegion(): Region {
    let region: Region;
    region = this.regionList.filter(
      reg => reg.id === this.formGroup.controls['region'].value
    )[0];
    return region;
  }

  // getSelectedCountries(): number[] {
  //   let countries: number[] = [];
  //   this.countryList.forEach(country => {
  //     countries.push(country.id);
  //   });
  //   return countries;
  // }

  // getSelectedEntities(): number[] {
  //   let entitites: number[] = [];
  //   this.countryList.forEach(entity => {
  //     entitites.push(entity.id);
  //   });
  //   return entitites;
  // }

}
