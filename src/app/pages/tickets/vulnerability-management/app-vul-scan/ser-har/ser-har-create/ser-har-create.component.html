<app-card-container [titleCard]="'VM.AVS.SER-HAR' | translate">
  <form class="form form-label-right" [formGroup]="formGroup">
    <div class="form-group row">
      <div class="col-lg-4">
        <mat-form-field class="ols-form-control" appearance="fill">
          <mat-label [translate]="'VM.FLD.REQUESTED_BY'"></mat-label>
          <input
            matInput
            [placeholder]="'VM.FLD.REQUESTED_BY' | translate"
            [minlength]="minLength.GENERAL"
            [maxlength]="maxLength.GENERAL"
            formControlName="requestedBy"
            required
          />
          <mat-error>
            <app-control-error
              [validationSignal]="
                validatorService.validateArray(formControls.requestedBy, [
                  {
                    valType: 'required',
                    message: ('VALIDATION.ERROR.REQUIRED' | translate)
                  }
                ])
              "
            >
            </app-control-error>
          </mat-error>
        </mat-form-field>
        <mat-form-field class="ols-form-control" appearance="fill">
          <mat-label [translate]="'VM.FLD.EMAIL'"></mat-label>
          <input
            matInput
            type="email"
            appEmail
            [placeholder]="'VM.FLD.EMAIL' | translate"
            [minlength]="minLength.EMAIL"
            [maxlength]="maxLength.EMAIL"
            formControlName="email"
            required
          />
          <mat-error>
            <app-control-error
              [validationSignal]="
                validatorService.validateArray(formControls.email, [
                  {
                    valType: 'required',
                    message: ('VALIDATION.ERROR.REQUIRED' | translate)
                  },
                  {
                    valType: 'email',
                    message: ('VALIDATION.ERROR.EMAIL' | translate)
                  }
                ])
              "
            >
            </app-control-error>
          </mat-error>
        </mat-form-field>
        <mat-form-field class="ols-form-control" appearance="fill">
          <mat-label [translate]="'VM.FLD.SCOTIA_ID'"></mat-label>
          <input
            matInput
            [placeholder]="'VM.FLD.SCOTIA_ID' | translate"
            [minlength]="minLength.GENERAL"
            [maxlength]="maxLength.GENERAL"
            formControlName="id"
            required
          />
          <mat-error>
            <app-control-error
              [validationSignal]="
                validatorService.validateArray(formControls.id, [
                  {
                    valType: 'required',
                    message: ('VALIDATION.ERROR.REQUIRED' | translate)
                  }
                ])
              "
            >
            </app-control-error>
          </mat-error>
        </mat-form-field>
        <mat-form-field class="ols-form-control" appearance="fill">
          <mat-label [translate]="'VM.FLD.REQUEST_AREA'"></mat-label>
          <input
            matInput
            [placeholder]="'VM.FLD.REQUEST_AREA' | translate"
            formControlName="requestArea"
          />
          <mat-error>
            <app-control-error
              [validationSignal]="
                validatorService.validateArray(formControls.requestArea, [
                  {
                    valType: 'required',
                    message: ('VALIDATION.ERROR.REQUIRED' | translate)
                  }
                ])
              "
            >
            </app-control-error>
          </mat-error>
        </mat-form-field>
        <mat-form-field class="ols-form-control" appearance="fill">
          <mat-label [translate]="'Tipo de solicitud'"></mat-label>
          <input
            matInput
            [placeholder]="'Tipo de solicitud' | translate"
            formControlName="requestTypeName"
            required
          />
          <mat-error>
            <app-control-error
              [validationSignal]="
                validatorService.validateArray(formControls.requestTypeName, [
                  {
                    valType: 'required',
                    message: ('VALIDATION.ERROR.REQUIRED' | translate)
                  }
                ])
              "
            >
            </app-control-error>
          </mat-error>
        </mat-form-field>
        <div
          class="mat-form-field-wrapper"
          *ngIf="isNewTicket || ticket.idStatus == 104"
        >
          <button (click)="openRegionModal()" mat-raised-button color="warn">
            <mat-icon matPrefix>language</mat-icon>
            {{ "VM.BTN.REGION" | translate }}
          </button>
        </div>
        <mat-form-field
          style="display: none"
          class="ols-form-control"
          appearance="fill"
        >
          <mat-label [translate]="'VM.FLD.SELECTED_REGIONS'"></mat-label>
          <input
            matInput
            [placeholder]="'VM.FLD.SELECTED_REGIONS' | translate"
            formControlName="selectedRegions"
            readonly
          />
        </mat-form-field>
        <mat-form-field
          style="display: none"
          class="ols-form-control"
          appearance="fill"
        >
          <mat-label [translate]="'VM.FLD.SELECTED_COUNTRIES'"></mat-label>
          <input
            matInput
            [placeholder]="'VM.FLD.SELECTED_COUNTRIES' | translate"
            formControlName="selectedCountries"
            readonly
          />
        </mat-form-field>
        <mat-form-field
          style="display: none"
          class="ols-form-control"
          appearance="fill"
        >
          <mat-label [translate]="'VM.FLD.ENTITY'"></mat-label>
          <input
            matInput
            [placeholder]="'VM.FLD.ENTITY' | translate"
            formControlName="entity"
            readonly
          />
        </mat-form-field>
        <mat-form-field class="ols-form-control" appearance="fill">
          <mat-label [translate]="'VM.FLD.SELECTED_REGIONS'"></mat-label>
          <input
            matInput
            [placeholder]="'VM.FLD.SELECTED_REGIONS' | translate"
            [value]="regionDesc"
            readonly
          />
        </mat-form-field>
        <mat-form-field class="ols-form-control" appearance="fill">
          <mat-label [translate]="'VM.FLD.SELECTED_COUNTRIES'"></mat-label>
          <input
            matInput
            [placeholder]="'VM.FLD.SELECTED_COUNTRIES' | translate"
            [value]="countriesList"
            readonly
          />
        </mat-form-field>
        <mat-form-field class="ols-form-control" appearance="fill">
          <mat-label [translate]="'VM.FLD.ENTITY'"></mat-label>
          <input
            matInput
            [placeholder]="'VM.FLD.ENTITY' | translate"
            [value]="entitiesList"
            readonly
          />
        </mat-form-field>
        <mat-form-field class="ols-form-control" appearance="fill">
          <mat-label [translate]="'VM.FLD.LOCAL_CISO'"></mat-label>
          <input
            matInput
            [placeholder]="'VM.FLD.LOCAL_CISO' | translate"
            formControlName="localCiso"
          />
          <mat-error>
            <app-control-error
              [validationSignal]="
                validatorService.validateArray(formControls.localCiso, [
                  {
                    valType: 'required',
                    message: ('VALIDATION.ERROR.REQUIRED' | translate)
                  }
                ])
              "
            >
            </app-control-error>
          </mat-error>
        </mat-form-field>
      </div>
      <div class="col-lg-4"></div>
      <div class="col-lg-4">
        <ng-container *ngIf="!isNewTicket">
          <app-ser-har-view (viewData)="getViewData($event)"></app-ser-har-view>
        </ng-container>
      </div>
    </div>

    <h3 [translate]="'VM.AVS.IP360.TITLE.TEAM_LIST'"></h3>
    <div *ngIf="isNewTicket" class="form-group row">
      <div class="col-lg-12">
        <!-- <div class="mat-form-field-wrapper"> -->
        <button
          type="button"
          class="mr-4"
          mat-raised-button
          color="warn"
          (click)="openUpsertTeamModal()"
        >
          <mat-icon matPrefix>add</mat-icon>
          {{ "VM.AVS.IP360.BTN.ADD_TEAM" | translate }}
        </button>
        <app-file-upload
          (onFile)="pushObjFile($event)"
          [control]="'teamList'"
        ></app-file-upload>
        <!-- </div>        -->
      </div>
    </div>

    <app-uploaded-file
      *ngIf="ticket && objFiles.length > 0"
      [objFile]="getFileByControl('teamList')"
    >
    </app-uploaded-file>

    <div *ngIf="!ticket || objFiles.length == 0" class="form-group row">
      <div class="example-container mat-elevation-z8">
        <!-- Table -->
        <table
          #table
          mat-table
          [dataSource]="dataSource"
          class="mat-elevation-z8 w-100"
        >
          <ng-container matColumnDef="country">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.SER-HAR.TABLE.TEAM_LIST.H1'"
            ></th>
            <td mat-cell *matCellDef="let row">{{ row.country.value }}</td>
          </ng-container>

          <ng-container matColumnDef="hostName">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.SER-HAR.TABLE.TEAM_LIST.H2'"
            ></th>
            <td mat-cell *matCellDef="let row">{{ row.hostName }}</td>
          </ng-container>

          <ng-container matColumnDef="ip">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.SER-HAR.TABLE.TEAM_LIST.H3'"
            ></th>
            <td mat-cell *matCellDef="let row">{{ row.ip }}</td>
          </ng-container>

          <ng-container matColumnDef="operatingSystem">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.SER-HAR.TABLE.TEAM_LIST.H4'"
            ></th>
            <td mat-cell *matCellDef="let row">{{ row.operatingSystem }}</td>
          </ng-container>

          <ng-container matColumnDef="serverType">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.SER-HAR.TABLE.TEAM_LIST.H5'"
            ></th>
            <td mat-cell *matCellDef="let row">{{ row.serverType }}</td>
          </ng-container>

          <ng-container matColumnDef="domain">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.SER-HAR.TABLE.TEAM_LIST.H6'"
            ></th>
            <td mat-cell *matCellDef="let row">{{ row.domain }}</td>
          </ng-container>

          <ng-container matColumnDef="clasification">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.SER-HAR.TABLE.TEAM_LIST.H7'"
            ></th>
            <td mat-cell *matCellDef="let row">{{ row.clasification }}</td>
          </ng-container>

          <ng-container matColumnDef="passwordAuth">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.SER-HAR.TABLE.TEAM_LIST.H8'"
            ></th>
            <td mat-cell *matCellDef="let row">{{ row.passwordAuth }}</td>
          </ng-container>

          <ng-container matColumnDef="epmCode">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.SER-HAR.TABLE.TEAM_LIST.H9'"
            ></th>
            <td mat-cell *matCellDef="let row">{{ row.epmCode }}</td>
          </ng-container>

          <ng-container matColumnDef="applicationName">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.SER-HAR.TABLE.TEAM_LIST.H10'"
            ></th>
            <td mat-cell *matCellDef="let row">{{ row.applicationName }}</td>
          </ng-container>

          <ng-container matColumnDef="score">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.IP360.TABLE.TEAM_LIST.H6'"
            ></th>
            <td mat-cell *matCellDef="let row">{{ row.score }}</td>
          </ng-container>

          <ng-container matColumnDef="riskLevel">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.IP360.TABLE.TEAM_LIST.H7'"
            ></th>
            <td mat-cell *matCellDef="let row">
              {{ row.riskLevel ? row.riskLevel.description : "" }}
            </td>
          </ng-container>

          <ng-container matColumnDef="result">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.IP360.TABLE.TEAM_LIST.H8'"
            ></th>
            <td mat-cell *matCellDef="let row">
              {{
                row.requesterResult ? row.requesterResult.description : ""
              }}
            </td>
          </ng-container>

          <ng-container matColumnDef="errorType">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.IP360.TABLE.TEAM_LIST.H9'"
            ></th>
            <td mat-cell *matCellDef="let row">
              {{ row.errorType ? row.errorType.description : "" }}
            </td>
          </ng-container>

          <ng-container matColumnDef="report">
            <th
              mat-header-cell
              *matHeaderCellDef
              [translate]="'VM.AVS.IP360.TABLE.TEAM_LIST.H10'"
            ></th>
            <td mat-cell *matCellDef="let row; let i = index">
              {{
                row.report
                  ? row.report.name
                  : "ARCHIVO
                            NO CARGADO"
              }}
              <mat-icon
                *ngIf="row.report"
                style="margin-left: 15px; cursor: pointer"
                (click)="downloadTeamFile(i)"
                matSuffix
                >download</mat-icon
              >
            </td>
          </ng-container>

          <ng-container matColumnDef="actions" stickyEnd>
            <th mat-header-cell 
                *matHeaderCellDef 
                [translate]="'AUDITORY.ACTION_PLANS_COL.ACTIONS'"
                style="background-color: rgb(237, 7, 34);"
            ></th>
            <td mat-cell *matCellDef="let element; let i = index">
              <button
                *ngIf="isNewTicket"
                type="button"
                mat-icon-button
                color="warn"
                (click)="openUpsertTeamModal(element, i)"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                *ngIf="!isNewTicket && ticket.idStatus == 5"
                type="button"
                mat-icon-button
                color="warn"
                (click)="openAddRiskLevelModal(element, i)"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                *ngIf="isNewTicket"
                type="button"
                mat-icon-button
                color="warn"
                (click)="deleteTeam(i)"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" colspan="4">No data</td>
          </tr>
        </table>
      </div>
    </div>

    <app-action-plans
      [ticket]="ticket"
      *ngIf="
        !isNewTicket &&
        ticket &&
        userPolicies.includes('IS&C_Staff_Ejecutor') &&
        (ticket.idStatus == 5 || ticket.idStatus == 7 || ticket.idStatus == 8)
      "
    >
    </app-action-plans>

    <mat-form-field
      *ngIf="!isNewTicket || ticket.idStatus == 104"
      class="example-full-width"
    >
      <textarea
        matInput
        readonly
        id="comments"
        formControlName="comments"
        [placeholder]="'VM.AVS.COMMENTS' | translate"
        rows="6"
      ></textarea>
    </mat-form-field>

    <mat-form-field
      *ngIf="ticket.idStatus == 5 || ticket.idStatus == 104 || isNewTicket"
      class="example-full-width"
    >
      <textarea
        matInput
        id="additionalComments"
        formControlName="additionalComments"
        [placeholder]="'VM.AVS.ADITIONAL_COMMENTS' | translate"
        [maxlength]="maxLength.COMMENTS"
      ></textarea>
    </mat-form-field>

    <app-udf
      [formName]="FORM_NAME"
      (getFormGroup)="setUdfForm($event)"
    ></app-udf>

    <app-action-buttons
      [ticket]="ticket"
      [canBeClosed]="canBeClosed"
      [form]="formGroup"
      *ngIf="
        !isNewTicket && ticket && userPolicies.includes('IS&C_Staff_Ejecutor')
      "
    >
    </app-action-buttons>

    <div class="form-group row" *ngIf="isNewTicket">
      <div class="col-lg-12">
        <button
          class="mr-4 ols-action-buttons"
          (click)="onSubmit()"
          mat-raised-button
          color="warn"
        >
          {{ "VM.BTN.SEND" | translate }}
        </button>
        <button
          class="ols-action-buttons"
          mat-raised-button
          (click)="goToList()"
          color="warn"
        >
          {{ "VM.BTN.CANCEL" | translate }}
        </button>
      </div>
    </div>
  </form>
</app-card-container>
