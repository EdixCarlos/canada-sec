import { Component, EventEmitter, Input, OnInit, Output } from '@angular/core';
import { FormBuilder, FormGroup } from '@angular/forms';
import { take } from 'rxjs/operators';
import { DbTicket, ObjFile } from 'src/app/core/model/db-ticket.model';
import { AuthenticationService } from 'src/app/modules/auth';
import { MinLength, MaxLength, TicketStatusJSON } from 'src/app/shared/constants';

enum TicketStatus {
  Initial = 0,
  Registered = 1,
  Rejected = 2,
  Approved = 3,
  Assigned = 4,
  InProcess = 5,
  Partial = 6,
  Attended = 7,
  Closed = 8,
  OpeIni = 9,
  Reassign = 10,
  CancelledByUser = 11,
  Returned = 12,
  Initialized = 101,
  Divided = 102,
  AdditionalAuthPending = 103,
  UserActionPending = 104,
  Cancelled = 105,
  AssignPending = 106,
  AnalystActionPending = 107,
  Updating = 404,
  SystemCancelled = 400
}

@Component({
  selector: 'app-webinspect-view',
  templateUrl: './webinspect-view.component.html',
  styleUrls: ['./webinspect-view.component.scss']
})
export class WebinspectViewComponent implements OnInit {
  @Output() viewData = new EventEmitter<any>();
  @Output() viewFile = new EventEmitter<any>();

  public ticket: DbTicket = new DbTicket();

  public ticketStatus = TicketStatusJSON;

  formGroup: FormGroup;
  public minLength = MinLength;
  public maxLength = MaxLength;

  public ticketsList = TicketStatus;

  public userPolicies;

  public objFile: ObjFile;

  constructor(
    private fb: FormBuilder,
    private authService: AuthenticationService
  ) { }

  ngOnInit(): void {
    this.createForm();
    this.formGroup.disable();
    this.formControls.progress.enable();
    this.formControls.critic.enable();
    this.formControls.high.enable();
    this.formControls.medium.enable();
    this.formControls.low.enable();
    this.formControls.riskLevel.enable();
    this.formControls.result.enable();
  }

  checkObservable(ticket) {
    this.authService.user.pipe(take(1)).subscribe(
      (user) => {
        this.userPolicies = user.policies;
      }
    );
    this.ticket = ticket;
    this.setView(ticket);
  }

  get formControls() {
    return this.formGroup.controls;
  }

  createForm() {
    this.formGroup = this.fb.group({
      nroTicket: [''],
      requestDate: [null],
      attentionDate: [null],
      idStatus: [],
      assigned: [null],
      emailAssigned: [null],
      progress: [0],
      critic: [''],
      high: [''],
      medium: [''],
      low: [''],
      riskLevel: [''],
      result: [''],
    });
  }

  setView(ticket) {
    let data = JSON.parse(ticket.data);
    let datos = JSON.parse(data.datos);
    this.formControls.nroTicket.setValue(ticket.id);
    this.formControls.requestDate.setValue(this.dateFormatFun(ticket.requestDate));
    this.formControls.attentionDate.setValue(this.dateFormatFun(ticket.attentionDate));
    this.formControls.idStatus.setValue(this.ticketStatus[ticket.idStatus].description);
    this.formControls.assigned.setValue(data.nombre_ejecutor);
    this.formControls.emailAssigned.setValue(data.mail_ejecutor);
    this.formControls.progress.setValue(ticket.progress);
    this.formControls.critic.setValue(datos.critic);
    this.formControls.high.setValue(datos.high);
    this.formControls.medium.setValue(datos.medium);
    this.formControls.low.setValue(datos.low);
    this.formControls.riskLevel.setValue(datos.riskLevel);
    this.formControls.result.setValue(datos.result);
    if (datos.file) {
      this.objFile = datos.file;
    }
  }

  dateFormatFun(date) {
    if (date == null)
      return null;

    let localDate = new Date(date).toLocaleDateString();
    let localTime = new Date(date).toLocaleTimeString();

    return `${localDate} ${localTime}`;
  }

  updateForm() {
    this.viewData.emit(this.formGroup.getRawValue());
  }

  pushObjFile(objFile: ObjFile) {
    this.objFile = objFile;
    this.viewFile.emit(this.objFile);
  }

  getFileByControl(control) {
    return this.objFile;
  }
}